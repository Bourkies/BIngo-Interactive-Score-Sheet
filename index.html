<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --board-bg: #1a1a1a; --text-light: #f0f0f0; --text-dark: #222;
      --accent-color: #00b8d4; --modal-bg: rgba(20, 20, 20, 0.95);
      --input-bg: #333; --border-color: #444; --error-bg: #4d2a2a;
      --error-border: #c0392b; --font-main: 'Roboto', 'Helvetica Neue', 'Arial', sans-serif;
    }
    body {
      font-family: var(--font-main); background-color: var(--board-bg); color: var(--text-light);
      margin: 0; padding: 1rem; display: flex; flex-direction: column;
      align-items: center; min-height: 100vh; box-sizing: border-box;
    }
    .navbar {
      width: 100%;
      max-width: 1400px;
      background-color: var(--input-bg);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      margin-bottom: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
    }
    .nav-links a, .nav-actions button {
      color: var(--text-light);
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      transition: background-color 0.2s;
      background: none;
      border: none;
      font-size: 1rem;
      cursor: pointer;
    }
    .nav-links a:hover, .nav-actions button:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .nav-links a.active {
      background-color: var(--accent-color);
      color: var(--text-dark);
      font-weight: bold;
    }
    .controls {
      width: 100%; margin-bottom: 1rem; display: flex; justify-content: space-between;
      align-items: center; flex-wrap: wrap; gap: 1rem;
    }
    h1 { margin: 0; font-size: 1.5rem; font-weight: 500; }
    #team-selector {
      padding: 0.5rem 1rem; font-size: 1rem; background-color: var(--input-bg);
      color: var(--text-light); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;
    }
    #board-container {
      position: relative; width: 100%; background-size: cover; background-position: center;
      border-radius: 12px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5); overflow: hidden;
      display: flex; justify-content: center; align-items: center;
    }
    .tile-overlay {
      position: absolute; box-sizing: border-box;
      transition: background-color 0.3s ease, border-color 0.3s ease, transform 0.3s ease;
      display: flex; align-items: center; justify-content: center; text-align: center;
      color: white; font-weight: bold; text-shadow: 1px 1px 3px black;
      font-size: 0.9rem; padding: 4px; cursor: pointer;
    }
    .stamp-image {
      position: absolute; width: 100%; height: 100%; background-size: 100% 100%;
      background-repeat: no-repeat; pointer-events: none;
    }
    .info-container {
      display: flex; flex-direction: column; gap: 1.5rem; margin-top: 1.5rem; width: 100%;
    }
    #color-key-container {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem;
      padding: 1rem; background-color: var(--input-bg); border-radius: 8px;
    }
    .key-item { display: flex; align-items: center; gap: 0.5rem; }
    .key-color-box { width: 20px; height: 20px; border-radius: 4px; border: 1px solid var(--border-color); }
    #scoreboard-container {
      display: none; flex-direction: column; gap: 0.5rem; padding: 1rem;
      background-color: var(--input-bg); border-radius: 8px;
    }
    #scoreboard-container h2 { margin: 0 0 0.5rem 0; text-align: center; font-weight: 500; }
    .scoreboard-item { display: grid; grid-template-columns: 30px 1fr 60px; align-items: center; padding: 0.5rem; border-radius: 6px; }
    .scoreboard-item:nth-child(odd) { background-color: rgba(0,0,0,0.2); }
    .scoreboard-rank, .scoreboard-score { font-weight: bold; }
    .scoreboard-score { text-align: right; }
    #submission-modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
      background-color: var(--modal-bg); backdrop-filter: blur(5px); justify-content: center; align-items: center;
      padding: 1rem; box-sizing: border-box;
    }
    .modal-content {
      background-color: #2a2a2a; padding: 2rem; border-radius: 12px; width: 100%;
      max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative;
      max-height: 95vh; overflow-y: auto;
    }
    .close-button {
      position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem;
      font-weight: bold; color: #aaa; cursor: pointer; line-height: 1;
    }
    .close-button:hover { color: white; }
    #submission-form h2 { margin-top: 0; }
    #submission-form h3 { margin: 0.5rem 0 1rem 0; color: var(--accent-color); }
    #submission-form p { color: #ccc; }
    #submission-form label { display: block; margin-top: 1rem; }
    #submission-form input, #submission-form textarea {
      width: 100%; padding: 0.75rem; margin-top: 0.5rem; background-color: var(--input-bg);
      border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-light); box-sizing: border-box;
    }
    #submission-form .checkbox-container { display: flex; align-items: center; margin-top: 1.5rem; gap: 0.5rem; }
    #submission-form input[type="checkbox"] { width: auto; margin: 0; }
    #submission-form button {
      width: 100%; padding: 0.75rem; margin-top: 1.5rem; background-color: var(--accent-color);
      color: var(--text-dark); font-weight: bold; font-size: 1rem; border: none;
      border-radius: 8px; cursor: pointer; transition: background-color 0.2s;
    }
    #submission-form button:hover { background-color: #00d9f5; }
    #submission-form button:disabled { background-color: #555; cursor: not-allowed; }
    /* --- NEW: Evidence Input Styling --- */
    #evidence-container { display: flex; flex-direction: column; gap: 1rem; margin-top: 0.5rem; }
    .evidence-item {
        background-color: var(--input-bg); padding: 1rem; border-radius: 8px;
        border: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 0.75rem;
    }
    .evidence-item-header { display: flex; justify-content: space-between; align-items: center; }
    .evidence-item-header label { margin: 0; font-weight: bold; }
    .remove-evidence-btn {
        background: none; border: none; color: #aaa; font-size: 1.2rem;
        cursor: pointer; padding: 0 0.5rem; line-height: 1;
    }
    .remove-evidence-btn:hover { color: var(--error-border); }
    #add-evidence-btn {
        width: auto; padding: 0.5rem 1rem; margin-top: 1rem; background-color: transparent;
        color: var(--accent-color); border: 1px dashed var(--accent-color);
        font-weight: normal; font-size: 0.9rem;
    }
    #add-evidence-btn:hover { background-color: rgba(0, 184, 212, 0.1); }
    #loader { font-size: 1.2rem; }
    .error-message {
        padding: 2rem; background-color: var(--error-bg); border: 2px dashed var(--error-border);
        border-radius: 8px; text-align: center; width: 80%; word-wrap: break-word; position: absolute; z-index: 1;
    }
    #message-box {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background-color: #333; color: white; padding: 1rem 2rem; border-radius: 8px;
      z-index: 2000; opacity: 0; transition: opacity 0.5s; pointer-events: none;
    }
    #message-box.show { opacity: 1; }
    /* --- NEW: Tooltip Style --- */
    #tile-tooltip {
      display: none;
      position: fixed;
      z-index: 1001;
      background-color: #111;
      color: #fff;
      padding: 0.75rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      max-width: 300px;
      pointer-events: none;
      font-size: 0.9rem;
      line-height: 1.4;
    }
    #tile-tooltip h4 {
        margin: 0 0 0.5rem 0;
        color: var(--accent-color);
        font-size: 1rem;
    }
    #tile-tooltip p {
        margin: 0;
        color: #ccc;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="nav-links">
      <a href="<?= ScriptApp.getService().getUrl() ?>" class="active">Player View</a>
      <a href="<?= ScriptApp.getService().getUrl() ?>?page=admin">Admin View</a>
    </div>
    <div class="nav-actions">
      <!-- UPDATED: Refresh button functionality -->
      <button onclick="refreshData()">Refresh Data</button>
    </div>
  </div>

  <div class="controls">
    <h1 id="page-title">OSRS Bingo</h1>
    <select id="team-selector" onchange="handleTeamChange()"></select>
  </div>
  <div id="board-container">
    <div id="loader">Loading board...</div>
  </div>
  <div class="info-container">
    <div id="color-key-container"></div>
    <div id="scoreboard-container"></div>
  </div>
  <div id="submission-modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeModal()">&times;</span>
      <form id="submission-form" onsubmit="handleFormSubmit(event)">
        <!-- UPDATED: Tile ID and Name format -->
        <h2 id="modal-tile-name"></h2>
        <h3 id="modal-team-name"></h3>
        <p id="modal-tile-desc"></p>
        <input type="hidden" id="modal-tile-id">
        <label for="player-name">Player Name(s):</label>
        <input type="text" id="player-name" required>
        <label id="evidence-label">Evidence:</label>
        <div id="evidence-container"></div>
        <button type="button" id="add-evidence-btn" onclick="addEvidenceInput()">+ Add Evidence Item</button>
        <label for="notes">Notes and Comments:</label>
        <textarea id="notes" rows="3"></textarea>
        <div class="checkbox-container">
            <input type="checkbox" id="mark-as-complete">
            <label for="mark-as-complete">Mark as complete and ready for review</label>
        </div>
        <div class="checkbox-container">
            <input type="checkbox" id="requires-action">
            <label for="requires-action">Flag for Admin Action</label>
        </div>
        <label for="team-password">Team Password:</label>
        <input type="text" id="team-password" required>
        <button type="submit" id="submit-button">Save Progress</button>
      </form>
    </div>
  </div>
  <div id="message-box"></div>
  <!-- NEW: Tooltip element -->
  <div id="tile-tooltip"></div>

  <script>
    console.log('--- HTML SCRIPT LOADED --- Version 10');
    let boardDataCache = null;
    let currentTeam = '';

    document.addEventListener('DOMContentLoaded', fetchInitialData);

    // Function to handle refresh button click
    function refreshData() {
      showMessage('Refreshing data...', false);
      pollForUpdates();
    }

    function fetchInitialData() {
      document.getElementById('loader').style.display = 'block';
      google.script.run
        .withSuccessHandler(data => {
          if (data.error) {
            showMessage(data.error, true);
            document.getElementById('loader').style.display = 'none';
            return;
          }
          boardDataCache = data;
          populateTeamSelector(data.config.teamNames, data.config.loadFirstTeamByDefault);
          if (data.config.loadFirstTeamByDefault) {
            currentTeam = data.config.teamNames[0];
            document.getElementById('team-selector').value = currentTeam;
          }
          applyGlobalStyles(data.config.fullConfig);
          renderBoard();
          renderColorKey();
          renderScoreboard();
          document.getElementById('evidence-label').textContent = data.config.evidenceLabel;
          document.getElementById('loader').style.display = 'none';
        })
        .withFailureHandler(error => {
          showMessage('Failed to load board data: ' + error.message, true);
          document.getElementById('loader').style.display = 'none';
        })
        .getBoardData();
    }

    function pollForUpdates() {
      google.script.run
        .withSuccessHandler(updateData => {
          if (updateData && !updateData.error) {
            boardDataCache.teamData = updateData.teamData;
            boardDataCache.scoreboard = updateData.scoreboard;
            renderBoard();
            renderScoreboard();
          } else if (updateData && updateData.error) {
            console.error('Server returned an error during polling:', updateData.error);
          }
        })
        .withFailureHandler(error => {
            console.error('Polling request failed:', error.message);
        })
        .getLatestTeamData();
    }
    
    function applyGlobalStyles(config) {
        const elements = document.querySelectorAll('.navbar, .controls, #board-container, .info-container');
        const maxWidth = config['Max Page Width'];
        if (maxWidth) elements.forEach(el => el.style.maxWidth = `${maxWidth}px`);
    }

    function populateTeamSelector(teamNames, loadFirstTeam) {
      const selector = document.getElementById('team-selector');
      selector.innerHTML = '';
      if (!loadFirstTeam) {
        const placeholder = document.createElement('option');
        placeholder.value = ""; placeholder.textContent = "Select a Team...";
        placeholder.disabled = true; placeholder.selected = true;
        selector.appendChild(placeholder);
      }
      teamNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name; option.textContent = name;
        selector.appendChild(option);
      });
    }

    function handleTeamChange() {
      const selector = document.getElementById('team-selector');
      if (selector.value === "") return;
      currentTeam = selector.value;
      renderBoard();
    }

    function getTileStatus(tile, teamName) {
        if (!boardDataCache || !teamName || !boardDataCache.teamData[teamName]) return 'Locked';
        const teamTileStates = boardDataCache.teamData[teamName].tileStates;
        const state = teamTileStates[tile.id] || {};
        if (state.verified) return 'Verified';
        if (state.requiresAction) return 'Requires Action';
        if (state.complete) return 'Submitted';
        if (state.hasSubmission) return 'Partially Complete';
        const unlockOnVerifiedOnly = boardDataCache.config.unlockOnVerifiedOnly;
        const prereqsMet = tile.prerequisites.every(prereqId => {
            const prereqState = teamTileStates[prereqId] || {};
            return unlockOnVerifiedOnly ? prereqState.verified : (prereqState.verified || prereqState.complete);
        });
        return prereqsMet ? 'Unlocked' : 'Locked';
    }

    function renderBoard() {
      if (!boardDataCache || !currentTeam) {
        document.getElementById('board-container').innerHTML = '<div id="loader" style="display: block;">Please select a team to view the board.</div>';
        return;
      }

      const container = document.getElementById('board-container');
      container.innerHTML = '';
      const displayTeam = currentTeam;
      document.title = `${boardDataCache.config.pageTitle} : ${displayTeam}`;
      document.getElementById('page-title').textContent = document.title;
      
      const tooltip = document.getElementById('tile-tooltip');

      const renderTiles = () => {
        boardDataCache.tiles.forEach(tile => {
          const tileDiv = document.createElement('div');
          const status = getTileStatus(tile, displayTeam);
          const statusClass = status.replace(/\s+/g, '-').toLowerCase();
          tileDiv.className = `tile-overlay ${statusClass}`;
          const config = boardDataCache.config.fullConfig;
          const getProp = (propName) => tile.overrides[propName] !== undefined ? tile.overrides[propName] : config[propName];
          tileDiv.style.top = `${tile.top}%`; tileDiv.style.left = `${tile.left}%`;
          tileDiv.style.width = `${tile.width}%`; tileDiv.style.height = `${tile.height}%`;
          tileDiv.style.transform = `rotate(${tile.rotation || '0deg'})`;
          const color = getProp(`Tile ${status}`) || '#FFFFFF';
          const opacity = getProp(`${status} Opacity`) || 0.7;
          tileDiv.style.backgroundColor = hexToRgba(color, opacity);
          const shape = (getProp('Default Tile Shape') || 'Square').toLowerCase();
          const clipPaths = { 'ellipse': 'ellipse(50% 50% at 50% 50%)', 'circle': 'ellipse(50% 50% at 50% 50%)', 'diamond': 'polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)', 'triangle': 'polygon(50% 0%, 0% 100%, 100% 100%)', 'hexagon': 'polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)' };
          if (clipPaths[shape]) tileDiv.style.clipPath = clipPaths[shape];
          const borderWidth = getProp('Default Tile Border Width') || '2px';
          const borderColor = getProp('Default Tile Border Color') || 'transparent';
          tileDiv.style.border = `${borderWidth} solid ${borderColor}`;
          
          // --- UPDATED: Tooltip logic ---
          tileDiv.addEventListener('mousemove', (e) => {
              tooltip.innerHTML = `<h4>${tile.id}: ${tile.name}</h4><p>${tile.description}</p>`;
              tooltip.style.display = 'block';
              // Position tooltip relative to cursor
              tooltip.style.left = `${e.clientX + 15}px`;
              tooltip.style.top = `${e.clientY + 15}px`;
          });
          tileDiv.addEventListener('mouseout', () => {
              tooltip.style.display = 'none';
              tileDiv.style.borderColor = borderColor;
              tileDiv.style.borderWidth = borderWidth;
          });
          tileDiv.addEventListener('mouseover', () => {
              const hoverWidth = getProp('Hover Tile Border Width') || '3px';
              const hoverColor = getProp('Hover Tile Border Color') || 'var(--accent-color)';
              tileDiv.style.borderColor = hoverColor;
              tileDiv.style.borderWidth = hoverWidth;
          });

          const imageFailed = !!boardDataCache.config.imageUrlError || !boardDataCache.config.boardImageUrl;
          if(config['Show Tile Names'] || imageFailed) {
            const tileNameSpan = document.createElement('span');
            tileNameSpan.textContent = tile.name;
            tileDiv.appendChild(tileNameSpan);
          }
          const useStamp = getProp(`Use Stamp by Default (${status})`) === true;
          const stampImg = getProp(`Stamp Image (${status})`);
          if (useStamp && stampImg) {
              const stampScale = getProp(`Stamp Scale (${status})`) || 1;
              const stampRotation = getProp(`Stamp Rotation (${status})`) || '0deg';
              const stampPosition = getProp(`Stamp Position (${status})`) || 'center';
              const stampDiv = document.createElement('div');
              stampDiv.className = 'stamp-image';
              stampDiv.style.backgroundImage = `url('${stampImg}')`;
              stampDiv.style.backgroundPosition = stampPosition;
              stampDiv.style.transformOrigin = stampPosition;
              stampDiv.style.transform = `scale(${stampScale}) rotate(${stampRotation})`;
              tileDiv.appendChild(stampDiv);
          }
          if (status !== 'Locked') {
            tileDiv.onclick = () => openModal(tile, status);
          }
          container.appendChild(tileDiv);
        });
      };

      const imageUrl = boardDataCache.config.boardImageUrl;
      if (boardDataCache.config.imageUrlError) {
        container.style.aspectRatio = '1 / 1'; container.style.backgroundColor = 'var(--board-bg)';
        const errorDiv = document.createElement('div'); errorDiv.className = 'error-message';
        errorDiv.innerHTML = `<strong>Configuration Error</strong><br>${boardDataCache.config.imageUrlError}`;
        container.appendChild(errorDiv); renderTiles(); return;
      }
      if (!imageUrl) {
        container.style.aspectRatio = '1 / 1'; container.style.backgroundColor = 'var(--board-bg)';
        renderTiles(); return;
      }
      const img = new Image();
      img.onload = () => {
        container.style.aspectRatio = `${img.naturalWidth} / ${img.naturalHeight}`;
        container.style.backgroundImage = `url('${imageUrl}')`; renderTiles();
      };
      img.onerror = () => {
        container.style.aspectRatio = '1 / 1'; container.style.backgroundImage = 'none';
        container.style.backgroundColor = 'var(--board-bg)';
        const errorDiv = document.createElement('div'); errorDiv.className = 'error-message';
        errorDiv.innerHTML = `<strong>Image Failed to Load</strong>`;
        container.appendChild(errorDiv); renderTiles();
      };
      img.src = imageUrl;
    }
    
    function renderColorKey() {
        if (!boardDataCache) return;
        const keyContainer = document.getElementById('color-key-container');
        keyContainer.innerHTML = '';
        const config = boardDataCache.config.fullConfig;
        const keyOrder = ['Locked', 'Unlocked', 'Partially Complete', 'Submitted', 'Verified', 'Requires Action'];
        keyOrder.forEach(status => {
            const color = config[`Tile ${status}`];
            if (color) {
                const opacity = config[`${status} Opacity`] || 0.7;
                const keyItem = document.createElement('div');
                keyItem.className = 'key-item';
                const colorBox = document.createElement('div');
                colorBox.className = 'key-color-box';
                colorBox.style.backgroundColor = hexToRgba(color, opacity);
                const keyLabel = document.createElement('span');
                keyLabel.textContent = status;
                keyItem.appendChild(colorBox);
                keyItem.appendChild(keyLabel);
                keyContainer.appendChild(keyItem);
            }
        });
    }

    function renderScoreboard() {
        const container = document.getElementById('scoreboard-container');
        if (!boardDataCache || !boardDataCache.config.showScoreboard) {
            container.style.display = 'none';
            return;
        }
        container.style.display = 'flex';
        container.innerHTML = '<h2>Scoreboard</h2>';
        boardDataCache.scoreboard.forEach((team, index) => {
            const item = document.createElement('div');
            item.className = 'scoreboard-item';
            item.innerHTML = `<div class="scoreboard-rank">${index + 1}.</div><div class="scoreboard-team">${team.team}</div><div class="scoreboard-score">${team.score}</div>`;
            container.appendChild(item);
        });
    }

    // --- NEW: Dynamic Evidence Field Functions ---
    function addEvidenceInput(link = '', name = '') {
        const container = document.getElementById('evidence-container');
        const itemCount = container.children.length;

        const evidenceItemDiv = document.createElement('div');
        evidenceItemDiv.className = 'evidence-item';

        evidenceItemDiv.innerHTML = `
            <div class="evidence-item-header">
                <label>Evidence #${itemCount + 1}</label>
                <button type="button" class="remove-evidence-btn" onclick="this.parentElement.parentElement.remove(); renumberEvidenceItems();">&times;</button>
            </div>
            <input type="text" class="evidence-link" placeholder="Link (e.g., https://discord...)" value="${link}">
            <input type="text" class="evidence-name" placeholder="Name / Description" value="${name}">
        `;
        container.appendChild(evidenceItemDiv);
    }

    function renumberEvidenceItems() {
        const container = document.getElementById('evidence-container');
        const items = container.querySelectorAll('.evidence-item');
        items.forEach((item, index) => {
            const label = item.querySelector('label');
            if (label) {
                label.textContent = `Evidence #${index + 1}`;
            }
        });
    }

    function clearEvidenceInputs() {
        const container = document.getElementById('evidence-container');
        container.innerHTML = '';
    }

    function openModal(tile, status) {
      document.getElementById('submission-form').reset();
      document.getElementById('modal-tile-id').value = tile.id;
      // --- UPDATED: Set Tile ID and Name in the new format ---
      document.getElementById('modal-tile-name').textContent = `${tile.id}: ${tile.name}`;
      document.getElementById('modal-team-name').textContent = `Team: ${currentTeam}`;
      document.getElementById('modal-tile-desc').textContent = tile.description;

      const isEditable = status !== 'Verified';
      const formElements = document.querySelectorAll('#submission-form input, #submission-form textarea, #submission-form button');
      formElements.forEach(el => el.disabled = !isEditable);
      document.getElementById('submit-button').textContent = isEditable ? 'Save Progress' : 'Verified (Locked)';

      // Clear previous dynamic fields
      clearEvidenceInputs();

      google.script.run
        .withSuccessHandler(details => {
          if (details) {
            document.getElementById('player-name').value = details.playerName || '';
            document.getElementById('notes').value = details.notes || '';
            document.getElementById('mark-as-complete').checked = details.isComplete;
            document.getElementById('requires-action').checked = details.requiresAction;

            // Populate evidence fields
            let evidenceData = [];
            try {
                evidenceData = JSON.parse(details.evidence);
                if (!Array.isArray(evidenceData)) throw new Error("Not an array");
            } catch (e) {
                // Handle old plain text evidence for backward compatibility
                if (details.evidence) evidenceData = [{ link: details.evidence, name: '' }];
            }
            
            if (evidenceData.length > 0) {
                evidenceData.forEach(item => addEvidenceInput(item.link, item.name));
            } else {
                addEvidenceInput(); // Start with one empty item if no evidence exists
            }
          }
          document.getElementById('submission-modal').style.display = 'flex';
        })
        .getTileDetails(tile.id, currentTeam);
    }

    function closeModal() {
      document.getElementById('submission-modal').style.display = 'none';
    }

    function handleFormSubmit(event) {
      event.preventDefault();
      const submitButton = document.getElementById('submit-button');
      submitButton.disabled = true; submitButton.textContent = 'Submitting...';

      // --- NEW: Collect evidence data ---
      const evidenceItems = [];
      document.querySelectorAll('#evidence-container .evidence-item').forEach(item => {
          const link = item.querySelector('.evidence-link').value.trim();
          const name = item.querySelector('.evidence-name').value.trim();
          if (link || name) { // Only add if at least one field is filled
              evidenceItems.push({ link, name });
          }
      });

      const submissionData = {
        tileId: document.getElementById('modal-tile-id').value,
        playerName: document.getElementById('player-name').value,
        evidence: JSON.stringify(evidenceItems),
        notes: document.getElementById('notes').value,
        team: currentTeam,
        password: document.getElementById('team-password').value,
        isComplete: document.getElementById('mark-as-complete').checked,
        requiresAction: document.getElementById('requires-action').checked
      };
      
      google.script.run
        .withSuccessHandler(response => {
          if (response.success) {
            showMessage(response.message, false);
            pollForUpdates();
            clearEvidenceInputs();
            closeModal();
          } else {
            showMessage(response.message, true);
            submitButton.disabled = false;
            submitButton.textContent = 'Save Progress';
          }
        })
        .withFailureHandler(error => {
          showMessage('Submission failed: ' + error.message, true);
          submitButton.disabled = false;
          submitButton.textContent = 'Save Progress';
        })
        .submitOrUpdateTile(submissionData);
    }

    function showMessage(text, isError = false) {
      const box = document.getElementById('message-box');
      box.textContent = text;
      box.style.backgroundColor = isError ? '#c0392b' : '#27ae60';
      box.classList.add('show');
      setTimeout(() => box.classList.remove('show'), 4000);
    }
    
    function hexToRgba(colorStr, alpha) {
        if (!colorStr || typeof colorStr !== 'string') return `rgba(255, 255, 255, ${alpha})`;
        const sColor = colorStr.trim();
        if (sColor === 'transparent') return 'transparent';
        if (!sColor.startsWith('#')) return sColor;
        const hex = sColor.slice(1);
        let r = 0, g = 0, b = 0;
        if (hex.length === 3) {
            r = parseInt(hex[0] + hex[0], 16); g = parseInt(hex[1] + hex[1], 16); b = parseInt(hex[2] + hex[2], 16);
        } else if (hex.length === 6) {
            r = parseInt(hex.substring(0, 2), 16); g = parseInt(hex.substring(2, 4), 16); b = parseInt(hex.substring(4, 6), 16);
        } else { return `rgba(255, 255, 255, ${alpha})`; }
        if (isNaN(r) || isNaN(g) || isNaN(b)) return `rgba(255, 255, 255, ${alpha})`;
        return `rgba(${r},${g},${b},${alpha})`;
    }
  </script>
</body>
</html>
