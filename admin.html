<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Verification</title>
  <style>
    :root {
      --bg-color: #1e1e1e;
      --surface-color: #2d2d2d;
      --primary-text: #e0e0e0;
      --secondary-text: #a0a0a0;
      --accent-color: #00b8d4;
      --border-color: #444;
      --error-color: #e57373;
      --success-color: #81c784;
      --font-main: 'Roboto', 'Helvetica Neue', 'Arial', sans-serif;
    }
    body {
      font-family: var(--font-main);
      background-color: var(--bg-color);
      color: var(--primary-text);
      margin: 0;
      padding: 2rem;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .navbar {
      width: 100%;
      max-width: 1200px;
      background-color: var(--surface-color);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      margin-bottom: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
    }
    .nav-links a, .nav-actions button {
      color: var(--primary-text);
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      transition: background-color 0.2s;
      background: none;
      border: none;
      font-size: 1rem;
      cursor: pointer;
    }
    .nav-links a:hover, .nav-actions button:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .nav-links a.active {
      background-color: var(--accent-color);
      color: #111;
      font-weight: bold;
    }
    /* --- NEW: Global Loader --- */
    .global-loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(to right, var(--accent-color) 20%, #00d9f5 50%, var(--accent-color) 80%);
        background-size: 200% auto;
        animation: loading-animation 1.5s linear infinite;
        z-index: 9999;
        display: none; /* Hidden by default */
    }
    @keyframes loading-animation { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      color: var(--accent-color);
    }
    #login-view {
      max-width: 400px;
      margin: 4rem auto;
      padding: 2rem;
      background-color: var(--surface-color);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    #login-form label { display: block; margin-bottom: 0.5rem; }
    #login-form input {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--primary-text);
      box-sizing: border-box;
    }
    #login-form button {
      width: 100%;
      padding: 0.75rem;
      background-color: var(--accent-color);
      color: #111;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #login-error {
        color: var(--error-color);
        margin-top: 1rem;
        text-align: center;
        min-height: 1.2em;
    }
    #admin-view { display: none; }
    .filters {
        background-color: var(--surface-color);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        align-items: center;
    }
    .filters .filter-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .filters .filter-group label { font-weight: bold; }
    .filters input[type="text"], .filters select {
        padding: 0.5rem;
        background-color: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--primary-text);
    }
    /* --- NEW: Duplicates Panel Styles --- */
    #duplicates-panel {
        background-color: var(--surface-color);
        border: 1px solid var(--error-color);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    #duplicates-panel h2 {
        margin-top: 0;
        color: var(--error-color);
    }
    .duplicate-group {
        border-top: 1px solid var(--border-color);
        padding: 1rem 0;
    }
    .duplicate-group:first-child {
        border-top: none;
        padding-top: 0;
    }
    .duplicate-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.5rem;
        border-radius: 4px;
    }
    .duplicate-item:hover {
        background-color: rgba(255,255,255,0.05);
    }
    .duplicate-item label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
    .duplicate-item .status { font-style: italic; color: var(--secondary-text); }
    .table-wrapper { overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    th {
      background-color: #3a3a3a;
      font-weight: bold;
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      user-select: none;
    }
    th .sort-indicator {
        color: var(--accent-color);
        font-size: 0.8em;
    }
    tbody tr {
      cursor: pointer;
      transition: background-color 0.2s;
    }
    tbody tr:hover {
      background-color: #4a4a4a;
    }
    .status-verified { color: var(--success-color); }
    .status-submitted { color: #64b5f6; }
    .status-action { color: #f06292; }
    .status-partial { color: #ffd54f; }
    #edit-modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0;
      width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px); justify-content: center; align-items: center;
      padding: 1rem; box-sizing: border-box;
    }
    .modal-content {
      background-color: var(--surface-color); padding: 2rem; border-radius: 12px;
      width: 100%; max-width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative;
      max-height: 95vh; overflow-y: auto;
    }
    .close-button {
      position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem;
      font-weight: bold; color: #aaa; cursor: pointer; line-height: 1;
    }
    /* --- UPDATED: Modal Header Styles --- */
    .modal-content h2 { margin-top: 0; color: var(--primary-text); }
    .modal-content h3 { margin: 0.5rem 0 1rem 0; color: var(--accent-color); font-weight: 500;}
    .modal-content p#modal-tile-desc { margin-top: 0; color: #ccc; }
    .modal-section { margin-bottom: 1rem; }
    .modal-section strong { color: var(--secondary-text); display: block; margin-bottom: 0.25rem; }
    .modal-section span {
        background-color: var(--bg-color); padding: 0.75rem; border-radius: 6px;
        display: block; white-space: pre-wrap; word-wrap: break-word;
    }
    /* --- NEW: Evidence display in admin modal --- */
    .evidence-display-item { margin-bottom: 0.75rem; }
    .evidence-display-item:last-child { margin-bottom: 0; }
    .evidence-display-item strong { color: var(--primary-text); }
    .evidence-display-item a { color: var(--accent-color); text-decoration: none; word-break: break-all; }
    .evidence-display-item a:hover { text-decoration: underline; }

    .modal-content label { display: block; margin-top: 1rem; font-weight: bold; }
    .modal-content textarea {
        width: 100%; box-sizing: border-box; margin-top: 0.5rem; padding: 0.5rem;
        background-color: var(--bg-color); border: 1px solid var(--border-color);
        border-radius: 6px; color: var(--primary-text); resize: vertical;
    }
    .modal-controls { margin-top: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
    .modal-controls .checkbox-container { display: flex; align-items: center; gap: 0.75rem; }
    .modal-controls input[type="checkbox"] { width: 1.2rem; height: 1.2rem; }
    #update-button {
        padding: 0.75rem; margin-top: 1rem; background-color: var(--success-color);
        color: #111; font-weight: bold; border: none; border-radius: 8px; cursor: pointer;
    }
    #update-button:disabled { background-color: #555; cursor: not-allowed; }
    /* NEW: Message Box Style */
    #message-box {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background-color: #333; color: white; padding: 1rem 2rem; border-radius: 8px;
      z-index: 2000; opacity: 0; transition: opacity 0.5s; pointer-events: none;
    }
    #message-box.show { opacity: 1; }
  </style>
</head>
<body>
  <div id="global-loader" class="global-loader"></div>

  <div id="login-view" class="container">
    <h1>Admin Login</h1>
    <form id="login-form" onsubmit="handleLogin(event)">
      <label for="admin-password">Password</label>
      <input type="password" id="admin-password" required>
      <button type="submit" id="login-button">Login</button>
      <p id="login-error"></p>
    </form>
  </div>

  <div id="admin-view">
    <div class="navbar">
      <div class="nav-links">
        <a href="<?= ScriptApp.getService().getUrl() ?>">Player View</a>
        <a href="<?= ScriptApp.getService().getUrl() ?>?page=overview">Overview</a>
        <a href="<?= ScriptApp.getService().getUrl() ?>?page=admin" class="active">Admin View</a>
        <a href="<?= ScriptApp.getService().getUrl() ?>?page=setup">Board Setup</a>
      </div>
      <div class="nav-actions">
        <!-- UPDATED: Refresh button functionality -->
        <button onclick="refreshAdminData()">Refresh Data</button>
      </div>
    </div>
    <div class="container">
      <h1>Admin Verification</h1>
      <div id="duplicates-panel" style="display: none;">
        <h2>Resolve Duplicate Submissions</h2>
        <p>The following tiles have multiple entries from the same team. Select the one submission to keep as the official record for each group. The others will be archived and will no longer affect scores or tile status.</p>
        <div id="duplicates-container"></div>
      </div>

      <div class="filters">
        <div class="filter-group">
          <label for="filter-search">Search:</label>
          <input type="text" id="filter-search" oninput="renderTable()" placeholder="Filter by keyword...">
        </div>
        <div class="filter-group">
          <label for="filter-team">Team:</label>
          <select id="filter-team" onchange="renderTable()"></select>
        </div>
        <div class="filter-group">
          <label>Status:</label>
          <div class="filter-group">
            <input type="checkbox" id="filter-submitted" onchange="renderTable()" checked>
            <label for="filter-submitted">Submitted</label>
          </div>
          <div class="filter-group">
            <input type="checkbox" id="filter-action" onchange="renderTable()" checked>
            <label for="filter-action">Requires Action</label>
          </div>
          <div class="filter-group">
            <input type="checkbox" id="filter-partial" onchange="renderTable()">
            <label for="filter-partial">Partially Complete</label>
          </div>
          <div class="filter-group">
            <input type="checkbox" id="filter-verified" onchange="renderTable()">
            <label for="filter-verified">Verified</label>
          </div>
        </div>
      </div>
      <div class="table-wrapper">
        <table id="submissions-table">
          <thead>
            <tr>
              <th data-column="Timestamp">Timestamp<span class="sort-indicator"></span></th>
              <th data-column="Team">Team<span class="sort-indicator"></span></th>
              <th data-column="TileID">Tile ID<span class="sort-indicator"></span></th>
              <th data-column="TileName">Tile Name<span class="sort-indicator"></span></th>
              <th data-column="PlayerName">Player(s)<span class="sort-indicator"></span></th>
              <th data-column="Status">Status<span class="sort-indicator"></span></th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="edit-modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeModal()">&times;</span>
      <!-- UPDATED: Modal header layout -->
      <h2 id="modal-tile-name"></h2>
      <h3 id="modal-team-name"></h3>
      <p id="modal-tile-desc"></p>
      
      <div class="modal-section">
        <strong>Player(s):</strong> <span id="modal-player"></span>
      </div>
      <div class="modal-section">
        <strong>Evidence:</strong><div id="modal-evidence"></div>
      </div>
      <label for="modal-notes-edit">Notes (Editable):</label>
      <textarea id="modal-notes-edit" rows="4"></textarea>
      <div class="modal-controls">
        <div class="checkbox-container">
          <input type="checkbox" id="modal-verified">
          <label for="modal-verified">Admin Verified</label>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="modal-complete">
          <label for="modal-complete">Is Complete</label>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="modal-action">
          <label for="modal-action">Requires Action</label>
        </div>
      </div>
      <button id="update-button" onclick="handleUpdate()">Update Submission</button>
    </div>
  </div>
  <!-- NEW: Message box element -->
  <div id="message-box"></div>

  <script>
    let adminPassword = '';
    let allSubmissions = [];
    let allTiles = {};
    let currentSubmission = null;
    let duplicateGroups = [];
    let currentSort = { column: 'Timestamp', direction: 'desc' }; // Default sort

    function handleLogin(event) {
      event.preventDefault();
      const passwordInput = document.getElementById('admin-password');
      const loginButton = document.getElementById('login-button');
      const errorP = document.getElementById('login-error');
      adminPassword = passwordInput.value;
      loginButton.disabled = true;
      loginButton.textContent = 'Verifying...';
      errorP.textContent = '';
      showGlobalLoader();
      google.script.run
        .withSuccessHandler(response => {
            if (response && response.success) {
                allSubmissions = response.submissions;
                allTiles = response.tiles; 
                if (response.duplicates && response.duplicates.length > 0) {
                    duplicateGroups = response.duplicates;
                    renderDuplicatesPanel();
                }
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('admin-view').style.display = 'block';
                populateTeamFilter();
                addSortListeners();
                renderTable();
            } else {
                errorP.textContent = (response && response.message) ? response.message : 'Login failed.';
            }
        })
        .withFailureHandler(error => {
            errorP.textContent = 'Error: ' + error.message;
        })
        .getAdminData(adminPassword)
        .finally(() => {
            hideGlobalLoader();
            loginButton.disabled = false;
            loginButton.textContent = 'Login';
        });
    }

    // NEW: Function to populate the team filter dropdown
    function populateTeamFilter() {
        const teams = [...new Set(allSubmissions.map(sub => sub.Team))];
        const select = document.getElementById('filter-team');
        select.innerHTML = '<option value="all">All Teams</option>';
        teams.sort().forEach(team => {
            const option = document.createElement('option');
            option.value = team;
            option.textContent = team;
            select.appendChild(option);
        });
    }

    // NEW: Function to add click listeners for sorting
    function addSortListeners() {
        document.querySelectorAll('#submissions-table thead th').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.column;
                if (column) {
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'asc';
                    }
                    renderTable();
                }
            });
        });
    }

    // UPDATED: Refresh function
    function refreshAdminData() {
        const refreshButton = document.querySelector('.nav-actions button');
        showGlobalLoader();

        google.script.run
            .withSuccessHandler(response => {
                if (response && response.success) {
                    allSubmissions = response.submissions;
                    allTiles = response.tiles;
                    duplicateGroups = response.duplicates || [];
                    if (duplicateGroups.length > 0) {
                        renderDuplicatesPanel();
                    } else {
                        document.getElementById('duplicates-panel').style.display = 'none';
                    }
                    populateTeamFilter(); // Repopulate in case teams changed
                    renderTable();
                } else {
                    showMessage((response && response.message) ? 'Refresh failed: ' + response.message : 'Refresh failed.', true);
                }
            })
            .withFailureHandler(error => {
                showMessage('Error refreshing data: ' + error.message, true);
            })
            .getAdminData(adminPassword)
            .finally(() => hideGlobalLoader());
    }

    function getStatus(sub) {
        if (sub['Admin Verified']) return { text: 'Verified', class: 'status-verified' };
        if (sub['RequiresAction']) return { text: 'Requires Action', class: 'status-action' };
        if (sub['IsComplete']) return { text: 'Submitted', class: 'status-submitted' };
        return { text: 'Partially Complete', class: 'status-partial' };
    }

    // NEW: Function to update sort indicators in table headers
    function updateSortIndicators() {
        document.querySelectorAll('#submissions-table thead th').forEach(th => {
            const indicator = th.querySelector('.sort-indicator');
            if (!indicator) return;
            if (th.dataset.column === currentSort.column) {
                indicator.textContent = currentSort.direction === 'asc' ? ' ▲' : ' ▼';
            } else {
                indicator.textContent = '';
            }
        });
    }

    // REWRITTEN: renderTable to include filtering and sorting
    function renderTable() {
      const tbody = document.querySelector('#submissions-table tbody');
      tbody.innerHTML = '';

      // Get filter values
      const teamFilter = document.getElementById('filter-team').value;
      const searchTerm = document.getElementById('filter-search').value.toLowerCase();
      const showSubmitted = document.getElementById('filter-submitted').checked;
      const showAction = document.getElementById('filter-action').checked;
      const showPartial = document.getElementById('filter-partial').checked;
      const showVerified = document.getElementById('filter-verified').checked;

      // 1. Filter submissions (ignore archived ones for the main table)
      let filteredSubmissions = allSubmissions.filter(sub => sub.IsArchived !== true).filter(sub => {
        // Status filter
        const status = getStatus(sub).text;
        const statusMatch = (status === 'Submitted' && showSubmitted) ||
                            (status === 'Requires Action' && showAction) ||
                            (status === 'Partially Complete' && showPartial) ||
                            (status === 'Verified' && showVerified);
        if (!statusMatch) return false;

        // Team filter
        if (teamFilter !== 'all' && sub.Team !== teamFilter) return false;

        // Search term filter
        if (searchTerm) {
            const tileName = (allTiles[sub.TileID] ? allTiles[sub.TileID].name : '').toLowerCase();
            const searchIn = [
                sub.Team.toLowerCase(),
                sub.TileID.toLowerCase(),
                tileName,
                sub['Player Name'].toLowerCase()
            ];
            if (!searchIn.some(text => text.includes(searchTerm))) {
                return false;
            }
        }
        return true;
      });

      // 2. Sort submissions
      if (currentSort.column) {
          filteredSubmissions.sort((a, b) => {
              let valA, valB;
              const col = currentSort.column;

              if (col === 'Timestamp') { valA = new Date(a.Timestamp); valB = new Date(b.Timestamp); } 
              else if (col === 'TileName') { valA = (allTiles[a.TileID] ? allTiles[a.TileID].name : '').toLowerCase(); valB = (allTiles[b.TileID] ? allTiles[b.TileID].name : '').toLowerCase(); } 
              else if (col === 'PlayerName') { valA = (a['Player Name'] || '').toLowerCase(); valB = (b['Player Name'] || '').toLowerCase(); } 
              else if (col === 'Status') { valA = getStatus(a).text.toLowerCase(); valB = getStatus(b).text.toLowerCase(); } 
              else { valA = (a[col] || '').toLowerCase(); valB = (b[col] || '').toLowerCase(); }

              let comparison = 0;
              if (valA > valB) { comparison = 1; } 
              else if (valA < valB) { comparison = -1; }
              return currentSort.direction === 'asc' ? comparison : comparison * -1;
          });
      }

      // 3. Render table
      if (filteredSubmissions.length === 0) {
        const row = tbody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 6;
        cell.textContent = 'No submissions match the current filters.';
        cell.style.textAlign = 'center';
      } else {
        filteredSubmissions.forEach(sub => {
          const row = tbody.insertRow();
          row.onclick = () => openModal(sub);
          const statusInfo = getStatus(sub);
          const tileName = allTiles[sub.TileID] ? allTiles[sub.TileID].name : 'Unknown Tile';
          row.innerHTML = `<td>${new Date(sub.Timestamp).toUTCString()}</td><td>${sub.Team}</td><td>${sub.TileID}</td><td>${tileName}</td><td>${sub['Player Name']}</td><td class="${statusInfo.class}">${statusInfo.text}</td>`;
        });
      }
      
      updateSortIndicators();
    }

    // --- NEW: Functions for handling duplicates ---
    function renderDuplicatesPanel() {
        const panel = document.getElementById('duplicates-panel');
        const container = document.getElementById('duplicates-container');
        container.innerHTML = '';

        if (!duplicateGroups || duplicateGroups.length === 0) {
            panel.style.display = 'none';
            return;
        }
        panel.style.display = 'block';

        duplicateGroups.forEach((group, index) => {
            // Sort group by timestamp descending (newest first)
            group.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));

            const groupKey = `${group[0].Team}-${group[0].TileID}`;
            const tileId = group[0].TileID;
            const tileName = allTiles[tileId]?.name || 'Unknown Tile';

            const groupDiv = document.createElement('div');
            groupDiv.className = 'duplicate-group';
            groupDiv.innerHTML = `<h3>${tileId}: ${tileName} (Team: ${group[0].Team})</h3>`;

            group.forEach((sub, subIndex) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'duplicate-item';
                const radioId = `radio-${index}-${subIndex}`;
                const status = getStatus(sub);

                itemDiv.innerHTML = `
                    <input type="radio" id="${radioId}" name="group-${groupKey}" value="${sub.Timestamp}" ${subIndex === 0 ? 'checked' : ''} />
                    <label for="${radioId}">
                        <strong>${new Date(sub.Timestamp).toUTCString()}</strong> by ${sub['Player Name']}
                        <span class="status">(${status.text})</span>
                    </label>
                `;

                const viewButton = document.createElement('button');
                viewButton.textContent = 'View';
                viewButton.style.marginLeft = 'auto'; // Push to the right
                viewButton.style.marginTop = '0';
                viewButton.style.padding = '4px 8px';
                viewButton.style.fontSize = '14px';
                viewButton.onclick = () => openModal(sub);

                itemDiv.appendChild(viewButton);
                groupDiv.appendChild(itemDiv);
            });

            const resolveButton = document.createElement('button');
            resolveButton.textContent = 'Resolve This Group';
            resolveButton.style.marginTop = '1rem';
            resolveButton.onclick = (event) => resolveDuplicates(groupKey, event.target);
            groupDiv.appendChild(resolveButton);

            container.appendChild(groupDiv);
        });
    }

    function resolveDuplicates(groupKey, buttonEl) {
        const selectedTimestamp = document.querySelector(`input[name="group-${groupKey}"]:checked`).value;
        const group = duplicateGroups.find(g => `${g[0].Team}-${g[0].TileID}` === groupKey);
        if (!group) return;

        buttonEl.disabled = true;
        buttonEl.textContent = 'Resolving...';
        showGlobalLoader();

        const keepIdentifier = group.find(sub => sub.Timestamp === selectedTimestamp);
        const archiveIdentifiers = group.filter(sub => sub.Timestamp !== selectedTimestamp);

        const payload = { password: adminPassword, keepIdentifier, archiveIdentifiers };

        google.script.run
            .withSuccessHandler(response => {
                if (response && response.success) {
                    showMessage('Duplicates resolved. Refreshing...', false);
                    refreshAdminData();
                } else { showMessage(response.message, true); }
            })
            .withFailureHandler(err => showMessage('Error: ' + err.message, true))
            .archiveSubmissions(payload)
            .finally(() => {
                hideGlobalLoader();
                buttonEl.disabled = false;
                buttonEl.textContent = 'Resolve This Group';
            });
    }

    function openModal(sub) {
      currentSubmission = sub;
      const tileInfo = allTiles[sub.TileID] || { name: 'Unknown Tile', description: 'No description found.' };
      
      // UPDATED: Populate the new modal header
      document.getElementById('modal-tile-name').textContent = `${sub.TileID}: ${tileInfo.name}`;
      document.getElementById('modal-team-name').textContent = `Team: ${sub.Team}`;
      document.getElementById('modal-tile-desc').textContent = tileInfo.description;

      document.getElementById('modal-player').textContent = sub['Player Name'];
      
      // --- UPDATED: Render evidence with clickable links ---
      const evidenceContainer = document.getElementById('modal-evidence');
      evidenceContainer.innerHTML = ''; // Clear previous
      const evidenceStr = sub.Evidence || '';
      let evidenceData = [];
      try {
        evidenceData = JSON.parse(evidenceStr);
        if (!Array.isArray(evidenceData)) throw new Error("Not an array");
      } catch (e) {
        // Handle old plain text for backward compatibility
        if (evidenceStr) evidenceData = [{ link: evidenceStr, name: '' }];
      }

      if (evidenceData.length > 0 && (evidenceData[0].link || evidenceData[0].name)) {
        evidenceData.forEach(item => {
          if (!item.link && !item.name) return; // Skip empty items
          const itemDiv = document.createElement('div');
          itemDiv.className = 'evidence-display-item';
          const namePart = `<strong>${item.name || 'Evidence'}:</strong> `;
          const linkPart = item.link 
            ? `<a href="${item.link}" target="_blank" rel="noopener noreferrer">${item.link}</a>` 
            : '(No link provided)';
          itemDiv.innerHTML = `${namePart}${linkPart}`;
          evidenceContainer.appendChild(itemDiv);
        });
      } else {
        evidenceContainer.textContent = '(No evidence provided)';
      }

      document.getElementById('modal-notes-edit').value = sub.Notes || '';
      document.getElementById('modal-verified').checked = sub['Admin Verified'];
      document.getElementById('modal-complete').checked = sub['IsComplete'];
      document.getElementById('modal-action').checked = sub['RequiresAction'];
      document.getElementById('edit-modal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('edit-modal').style.display = 'none';
      currentSubmission = null;
    }

    function handleUpdate() {
      if (!currentSubmission) return;
      const updateButton = document.getElementById('update-button');
      updateButton.disabled = true;
      showGlobalLoader();

      const updateData = {
        password: adminPassword,
        timestamp: new Date(currentSubmission.Timestamp).toISOString(),
        team: currentSubmission.Team,
        tileId: currentSubmission.TileID,
        notes: document.getElementById('modal-notes-edit').value,
        adminVerified: document.getElementById('modal-verified').checked,
        isComplete: document.getElementById('modal-complete').checked,
        requiresAction: document.getElementById('modal-action').checked
      };
      google.script.run
        .withSuccessHandler(response => {
          updateButton.disabled = false;
          if (response && response.success) {
            closeModal();
            showMessage('Submission updated successfully!', false);
            refreshAdminData(); // Refresh data after update
          } else {
            showMessage('Update failed: ' + response.message, true);
          }
        })
        .withFailureHandler(error => {
          showMessage('Update failed: ' + error.message, true);
          updateButton.disabled = false;
        })
        .updateSubmissionStatus(updateData)
        .finally(() => hideGlobalLoader());
    }
    
    // --- NEW: Global Loader Functions ---
    function showGlobalLoader() {
        document.getElementById('global-loader').style.display = 'block';
    }
    function hideGlobalLoader() {
        document.getElementById('global-loader').style.display = 'none';
    }

    // NEW: Message box function
    function showMessage(text, isError = false) {
      const box = document.getElementById('message-box');
      box.textContent = text;
      box.style.backgroundColor = isError ? 'var(--error-color)' : 'var(--success-color)';
      box.style.color = '#111'; // Dark text for better contrast
      box.classList.add('show');
      setTimeout(() => box.classList.remove('show'), 4000);
    }
  </script>
</body>
</html>
